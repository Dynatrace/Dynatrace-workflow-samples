metadata:
  version: "1"
  dependencies:
    apps:
      - id: dynatrace.automations
        version: ^1.700.0
      - id: dynatrace.slack
        version: ^2.0.1-dev.20240717T104733+ec59fa41
  inputs:
    - type: connection
      schema: app:dynatrace.slack:connection
      targets:
        - tasks.alert_in_slack.connection
workflow:
  title: "[Sample] Slack notification for critical container vulnerabilities"
  tasks:
    alert_in_slack:
      name: alert_in_slack
      description: "Send a Slack notification for the vulnerability findings. "
      action: dynatrace.slack:slack-send-message
      active: true
      input:
        channel: ""
        message: >-
          {
          	"blocks": [
          		{
          			"type": "header",
          			"text": {
          				"type": "plain_text",
          				"text": "{{ (_.finding.vulnerability_finding_events|first).get("vulnerability.risk.level") }} vulnerability was detected!",
          				"emoji": true
          			}
          		},
          		{
          			"type": "divider"
          		},
          		{
          			"type": "section",
          			"text": {
          				"type": "mrkdwn",
          				"text": "{{ (_.finding.vulnerability_finding_events|first).get("vulnerability.risk.level") }} vulnerability `{{ _.finding.get("vulnerability.external_id") }}` was detected in `{{ (_.finding.vulnerability_finding_events|first).get("container_image.repository") }}`"
          			},
          			"accessory": {
          				"type": "image",
          				"image_url": "https://dt-cdn.net/images/appsec-logo-with-bg-and-rounded-corners-200-8253a2bc6e.png",
          				"alt_text": "Dynatrace Application Security"
          			}
          		},
          		{
          			"type": "divider"
          		},
          		{
          			"type": "rich_text",
          			"elements": [
          				{
          					"type": "rich_text_section",
          					"elements": [
          						{
          							"type": "text",
          							"text": "Details:\n"
          						}
          					]
          				},
          				{
          					"type": "rich_text_list",
          					"style": "bullet",
          					"elements": [
          						{
          							"type": "rich_text_section",
          							"elements": [
          								{
          									"type": "text",
          									"text": "Finding source: "
          								},
          								{
          									"type": "text",
          									"text": "{{ (_.finding.vulnerability_finding_events|first).get("event.provider_product") }}"
          								}
          							]
          						},
          						{
          							"type": "rich_text_section",
          							"elements": [
          								{
          									"type": "text",
          									"text": "Registry ID: "
          								},
          								{
          									"type": "text",
          									"text": "{{ (_.finding.vulnerability_finding_events|first).get("container_image.registry") }}"
          								}
          							]
          						},
          						{
          							"type": "rich_text_section",
          							"elements": [
          								{
          									"type": "text",
          									"text": "Repository name: "
          								},
          								{
          									"type": "text",
          									"text": "{{ (_.finding.vulnerability_finding_events|first).get("container_image.repository") }}"
          								}
          							]
          						},
          						{
          							"type": "rich_text_section",
          							"elements": [
          								{
          									"type": "text",
          									"text": "Number of affected images: "
          								},
          								{
          									"type": "text",
          									"text": "{{_.finding.affected_images_count}}"
          								}
          							]
          						},
          						{
          							"type": "rich_text_section",
          							"elements": [
          								{
          									"type": "text",
          									"text": "Vulnerable component (version): "
          								},
          								{
          									"type": "text",
          									"text": "{{ (_.finding.vulnerability_finding_events|first).get("vulnerable_component.short_name") }} ({{ (_.finding.vulnerability_finding_events|first).get("vulnerable_component.version") }})"
          								}
          							]
          						}
          					]
          				}
          			]
          		},
          		{
          			"type": "divider"
          		},
          		{
          			"type": "section",
          			"text": {
          				"type": "mrkdwn",
          				"text": "Click to view all vulnerabilities findings in a notebook."
          			},
          			"accessory": {
          				"type": "button",
          				"text": {
          					"type": "plain_text",
          					"text": "View all findings",
          					"emoji": true
          				},
          				"url": "{{result("get_environment_url")}}/ui/intent/dynatrace.notebooks/view-query#%7B%22dt.query%22%3A%22fetch%20events%5Cn%2F%2F%20data%20access%5Cn%7C%20filter%20dt.system.bucket%20%3D%3D%20%5C%22default_security_custom_events%5C%22%5Cn%20%20%20%20%20AND%20event.type%20%3D%3D%20%5C%22VULNERABILITY_FINDING_EVENT%5C%22%5Cn%20%20%20%20%20AND%20affected_entity.type%3D%3D%5C%22CONTAINER_IMAGE%5C%22%5Cn%20%20%20%20%20AND%20isNotNull(vulnerable_component.name)%5Cn%7C%20dedup%20%7Baffected_entity.id%2C%20vulnerability.external_id%2C%20vulnerable_component.name%2C%5Cn%20%20%20%20%20%20%20%20%20container_image.registry%2C%20container_image.repository%2C%20container_image.tags%7D%2C%20sort%3A%20%7Btimestamp%20desc%7D%5Cn%2F%2F%20aggregation%20and%20custom%20filtering%5Cn%7C%20sort%20timestamp%20desc%22%2C%22dt.timeframe%22%3A%7B%22from%22%3A%22now()-7d%22%2C%22to%22%3A%22now()%22%7D%2C%22hideInput%22%3Afalse%2C%22sourceApplication%22%3A%22dynatrace.notebooks%22%2C%22title%22%3A%22List%20recent%20container%20vulnerability%20findings%22%2C%22visualization%22%3A%22recordView%22%2C%22visualizationSettings%22%3A%7B%22thresholds%22%3A%5B%5D%2C%22chartSettings%22%3A%7B%22gapPolicy%22%3A%22connect%22%2C%22circleChartSettings%22%3A%7B%22groupingThresholdType%22%3A%22relative%22%2C%22groupingThresholdValue%22%3A0%2C%22valueType%22%3A%22relative%22%7D%2C%22categoryOverrides%22%3A%7B%7D%2C%22categoricalBarChartSettings%22%3A%7B%22categoryAxis%22%3A%22affected_entity.name%22%2C%22categoryAxisLabel%22%3A%22affected_entity.name%22%2C%22valueAxis%22%3A%22vulnerability.risk.score%22%2C%22valueAxisLabel%22%3A%22vulnerability.risk.score%22%7D%2C%22hiddenLegendFields%22%3A%5B%5D%2C%22fieldMapping%22%3A%7B%22timestamp%22%3A%22timestamp%22%2C%22leftAxisValues%22%3A%5B%22vulnerability.risk.score%22%5D%2C%22leftAxisDimensions%22%3A%5B%22ResponseMetadata%22%5D%7D%7D%2C%22singleValue%22%3A%7B%22showLabel%22%3Atrue%2C%22label%22%3A%22%22%2C%22prefixIcon%22%3A%22%22%2C%22recordField%22%3A%22timestamp%22%2C%22autoscale%22%3Atrue%2C%22alignment%22%3A%22center%22%2C%22colorThresholdTarget%22%3A%22value%22%7D%2C%22table%22%3A%7B%22rowDensity%22%3A%22condensed%22%2C%22enableSparklines%22%3Afalse%2C%22hiddenColumns%22%3A%5B%5D%2C%22lineWrapIds%22%3A%5B%5D%2C%22firstVisibleRowIndex%22%3A0%2C%22columnWidths%22%3A%7B%7D%7D%2C%22honeycomb%22%3A%7B%22shape%22%3A%22hexagon%22%2C%22legend%22%3A%22auto%22%2C%22dataMappings%22%3A%7B%22category%22%3A%22ResponseMetadata%22%2C%22value%22%3A%22timestamp%22%7D%7D%2C%22histogram%22%3A%7B%22dataMappings%22%3A%5B%7B%22valueAxis%22%3A%22vulnerability.risk.score%22%2C%22rangeAxis%22%3A%22%22%7D%5D%7D%7D%7D",
          				"action_id": "button-action"
          			}
          		}
          	]
          }
        reaction: []
        connection: ""
        workflowID: "{{ execution().workflow.id }}"
        channelType: id
        executionID: "{{ execution().id }}"
        executionDate: "{{ execution().started_at }}"
        appendToThread: false
        selectedRequestType: 0
        attachmentToggleValue: none
      position:
        x: 0
        y: 2
      predecessors:
        - get_vulnerabilites
        - get_environment_url
      conditions:
        states:
          get_vulnerabilites: SUCCESS
          get_environment_url: SUCCESS
        custom: '{{result("get_vulnerabilites").records|length > 0}}'
      concurrency: 1
      withItems: finding in {{ result("get_vulnerabilites").records }}
    get_vulnerabilites:
      name: get_vulnerabilites
      description: Query for new vulnerability findings in the last 24 hours.
      action: dynatrace.automations:execute-dql-query
      active: true
      input:
        query: >-
          fetch events, from: now() - 7d

          | filter dt.system.bucket == "default_security_custom_events"

          | filter event.kind == "SECURITY_EVENT"

          | filter event.category == "VULNERABILITY_MANAGEMENT"

          | filter affected_entity.type == "CONTAINER_IMAGE"

          | filter event.type == "VULNERABILITY_FINDING_EVENT"

          | filter vulnerability.risk.level == "CRITICAL"

          | fieldsAdd repository_full_path = concat(event.provider_product, ":",
          container_image.registry, ":", container_image.repository)

          | summarize {
                affected_images_count = count(),
                vulnerability_finding_events = collectArray(
                  record(
                    repository_full_path = repository_full_path,
                    affected_entity.id = affected_entity.id,
                    event.provider_product = event.provider_product,
                    container_image.registry = container_image.registry,
                    container_image.repository = container_image.repository,
                    vulnerable_component.version = vulnerable_component.version,
                    vulnerable_component.short_name = vulnerable_component.short_name,
                    vulnerability.risk.level = vulnerability.risk.level,
                    vulnerability.title = vulnerability.title,
                    vulnerability.external_id = vulnerability.external_id,
                    vulnerability.description = vulnerability.description,
                    container_image.tag = container_image.tag,
                    container_image.digest = container_image.digest,
                    scan_time = timestamp
                  )
                )
              }, by:{ vulnerability.external_id, repository_full_path}
          | filterOut iAny(vulnerability_finding_events[][scan_time] < now() -
          24h)

          | sort vulnerability_finding_events[][scan_time] desc
      customSampleResult: {}
      position:
        x: 0
        y: 1
      predecessors: []
      conditions:
        states: {}
        custom: ""
    get_environment_url:
      name: get_environment_url
      description: Fetch the environment URL.
      action: dynatrace.automations:run-javascript
      input:
        script: |-
          // optional import of sdk modules
          import { getEnvironmentUrl } from '@dynatrace-sdk/app-environment';

          export default async function () {
            return getEnvironmentUrl();
          }
      position:
        x: 1
        y: 1
      predecessors: []
  description: ""
  trigger:
    schedule:
      rule: null
      trigger:
        type: time
        time: 08:00
      timezone: Europe/Vienna
      isActive: false
      isFaulty: false
      filterParameters:
        earliestStart: 2024-04-10
      inputs: {}
  schemaVersion: 3
