metadata:
  version: "1"
  dependencies:
    apps:
      - id: dynatrace.email
        version: ^1.8.0
      - id: dynatrace.msteams
        version: ^2.0.5
      - id: dynatrace.slack
        version: ^3.0.4
  inputs: []
workflow:
  title: "Threat Detection Finding - Notification Sender"
  id: 16515850-2577-4ce7-996b-986125d496ff
  tasks:
    send_email:
      name: send_email
      description: Send email
      action: dynatrace.email:send-email
      input:
        cc: []
        to:
          - '{{ _.item["email"] }}'
        bcc: []
        content: >-
          [THREAT ALERT] New Detection Finding

          This message is automatically generated by Dynatrace.


          Detection summary:

          - Timestamp: {{ execution()["input"]["timestamp"] }}

          - Title: {{ execution()["input"]["title"] }}

          - Description: {{ execution()["input"]["description"] }}

          - Severity: {{ execution()["input"]["severity"] }} (Risk: {{
          execution()["input"]["risk"] }})

          - Detection type: {{ execution()["input"]["type"] }} 

          - Provider: {{ execution()["input"]["provider"] }}

          - Finding link: {{ execution()["input"]["findingLink"] }}


          Impacted asset:

          - Cluster: {{ execution()["input"]["cluster"] }}

          - Namespace: {{ execution()["input"]["namespace"] }}

          - Pod: {{ execution()["input"]["pod"] }} (UID: {{
          execution()["input"]["uid"] }}, IP: {{ execution()["input"]["ip"] }})


          Full detection finding:

          - raw_content: {{ execution()["input"]["content"] }}
        subject: "[THREAT ALERT] New Detection Finding"
      position:
        x: -1
        y: 1
      predecessors: []
      conditions:
        states: {}
        custom: '{{ execution()["input"]["email"] | length > 0 }}'
        else: SKIP
      concurrency: 1
      withItems: item in {{ execution()["input"]["email"] }}
    send_slack_notification:
      name: send_slack_notification
      description: Send a message to a Slack workspace
      action: dynatrace.slack:slack-send-message
      active: true
      input:
        channel: '{{ _.item["slack"] }}'
        message: >-
          [THREAT ALERT] New Detection Finding

          This message is automatically generated by Dynatrace.


          Detection summary:

          - Timestamp: {{ execution()["input"]["timestamp"] }}

          - Title: {{ execution()["input"]["title"] }}

          - Description: {{ execution()["input"]["description"] }}

          - Severity: {{ execution()["input"]["severity"] }} (Risk: {{
          execution()["input"]["risk"] }})

          - Detection type: {{ execution()["input"]["type"] }} 

          - Provider: {{ execution()["input"]["provider"] }}

          - Finding link: {{ execution()["input"]["findingLink"] }}


          Impacted asset:

          - Cluster: {{ execution()["input"]["cluster"] }}

          - Namespace: {{ execution()["input"]["namespace"] }}

          - Pod: {{ execution()["input"]["pod"] }} (UID: {{
          execution()["input"]["uid"] }}, IP: {{ execution()["input"]["ip"] }})


          Full detection finding:

          - raw_content: {{ execution()["input"]["content"] }}
        reaction: []
        connection: "{{ connection('app:dynatrace.slack:connection', _.item[\"slack\"]) }}"
        workflowID: "{{ execution().workflow.id }}"
        channelType: expression
        executionID: "{{ execution().id }}"
        executionDate: "{{ execution().started_at }}"
        appendToThread: false
        replyBroadcast: false
        selectedRequestType: 0
        attachmentToggleValue: none
      position:
        x: 1
        y: 1
      predecessors: []
      conditions:
        states: {}
        custom: '{{ execution()["input"]["slack"] | length > 0 }} '
        else: SKIP
      concurrency: 1
      withItems: item in {{ execution()["input"]["slack"] }}
    send_teams_notification:
      name: send_teams_notification
      description: Send messages and Adaptive Cards to Microsoft Teams channels
      action: dynatrace.msteams:send-message
      active: true
      input:
        message: >-
          [THREAT ALERT] New Detection Finding

          This message is automatically generated by Dynatrace.


          Detection summary:

          - Timestamp: {{ execution()["input"]["timestamp"] }}

          - Title: {{ execution()["input"]["title"] }}

          - Description: {{ execution()["input"]["description"] }}

          - Severity: {{ execution()["input"]["severity"] }} (Risk: {{
          execution()["input"]["risk"] }})

          - Detection type: {{ execution()["input"]["type"] }} 

          - Provider: {{ execution()["input"]["provider"] }}

          - Finding link: {{ execution()["input"]["findingLink"] }}


          Impacted asset:

          - Cluster: {{ execution()["input"]["cluster"] }}

          - Namespace: {{ execution()["input"]["namespace"] }}

          - Pod: {{ execution()["input"]["pod"] }} (UID: {{
          execution()["input"]["uid"] }}, IP: {{ execution()["input"]["ip"] }})


          Full detection finding:

          - raw_content: {{ execution()["input"]["content"] }}
        connectionId: "{{ connection('app:dynatrace.msteams:connection',
          _.item[\"msTeams\"] ) }}"
      position:
        x: 0
        y: 1
      predecessors: []
      conditions:
        states: {}
        custom: '{{ execution()["input"]["msTeams"] | length > 0 }}'
        else: SKIP
      concurrency: 1
      withItems: item in {{ execution()["input"]["msTeams"] }}
  description: ""
  trigger: {}
  schemaVersion: 3
  result: null
  input: {}
  hourlyExecutionLimit: 1000
  type: STANDARD
