metadata:
  version: "1"
  dependencies:
    apps:
      - id: dynatrace.email
        version: ^1.8.0
      - id: dynatrace.msteams
        version: ^2.0.5
      - id: dynatrace.slack
        version: ^3.0.4
  inputs: []
workflow:
  title: Threat Detection Notification Sender
  id: 34515850-2577-4ce7-996b-986125d496ff
  tasks:
    send_email:
      name: send_email
      description: Send email
      action: dynatrace.email:send-email
      active: true
      input:
        cc: []
        to:
          - '{{ _.item["email"] }}'
        bcc: []
        content: |-
          **[THREAT DETECTION ALERT] New Detection Finding**

          This message is automatically generated by Dynatrace Workflows.

          {{ execution()["input"]["textMsg"] }}
        subject: "[THREAT DETECTION ALERT] New Detection Finding"
      position:
        x: -1
        y: 1
      predecessors: []
      conditions:
        states: {}
        custom: '{{ execution()["input"]["event"]["email"] | length > 0 }}'
        else: SKIP
      concurrency: 1
      withItems: item in {{ execution()["input"]["event"]["email"] }}
    send_slack_notification:
      name: send_slack_notification
      description: Send a message to a Slack workspace
      action: dynatrace.slack:slack-send-message
      active: true
      input:
        channel: '{{ _.item["slack"] }}'
        message: |-
          **[THREAT DETECTION ALERT] New Detection Finding**

          This message is automatically generated by Dynatrace Workflows.

          {{ execution()["input"]["textMsg"] }}
        reaction: []
        connection: "{{ connection('app:dynatrace.slack:connection', _.item[\"slack\"]) }}"
        workflowID: "{{ execution().workflow.id }}"
        channelType: expression
        executionID: "{{ execution().id }}"
        executionDate: "{{ execution().started_at }}"
        appendToThread: false
        replyBroadcast: false
        selectedRequestType: 0
        attachmentToggleValue: none
      position:
        x: 1
        y: 1
      predecessors: []
      conditions:
        states: {}
        custom: '{{ execution()["input"]["event"]["slackChannels"] | length > 0 }} '
        else: SKIP
      concurrency: 1
      withItems: item in {{ execution()["input"]["event"]["slackChannels"] }}
    send_teams_notification:
      name: send_teams_notification
      description: Send messages and Adaptive Cards to Microsoft Teams channels
      action: dynatrace.msteams:send-message
      active: true
      input:
        message: |-
          **[THREAT DETECTION ALERT] New Detection Finding**

          This message is automatically generated by Dynatrace Workflows.

          {{ execution()["input"]["textMsg"] }}
        connectionId: "{{ connection('app:dynatrace.msteams:connection',
          _.item[\"msTeams\"] ) }}"
      position:
        x: 0
        y: 1
      predecessors: []
      conditions:
        states: {}
        custom: '{{ execution()["input"]["event"]["msTeams"] | length > 0 }}'
        else: SKIP
      concurrency: 1
      withItems: item in {{ execution()["input"]["event"]["msTeams"] }}
  description: ""
  trigger: {}
  schemaVersion: 3
  result: null
  input: {}
  hourlyExecutionLimit: 1000
  type: STANDARD
